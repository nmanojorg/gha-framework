name: "Docker Build (Multi-Arch)"
description: "Builds a multi-arch Docker image using a single Dockerfile. Supports env build args, comma-separated image URLs. Automatically sets up QEMU for cross-architecture builds."

runs:
  using: "composite"
  steps:
    - name: Set up QEMU (for cross-arch builds)
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and Push Multi-Arch Image
      shell: bash
      run: |
        set -e

        IMAGE_URL="${GHA_CICD_DOCKER_IMAGE_URL}"
        DOCKER_CONTEXT="${GHA_CICD_DOCKER_CONTEXT:-.}"
        DOCKERFILE_PATH="${GHA_CICD_DOCKERFILE_PATH:-Dockerfile}"

        BUILD_ARG_OPTIONS=$(python3 "$GITHUB_ACTION_PATH/prepare_build_args.py" | tail -n 1)

        echo "::group::Building $IMAGE_URL for multi-arch ($DOCKERFILE_PATH)"

        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --file "$DOCKERFILE_PATH" \
          $BUILD_ARG_OPTIONS \
          -t "$IMAGE_URL" \
          --push \
          "$DOCKER_CONTEXT"

        echo "::endgroup::"