name: "Docker Build (Multi-Arch, Multi-Image)"
description: "Builds Docker images for multiple platforms and image URLs using env vars only."

runs:
  using: "composite"
  steps:
    - name: Debug Docker Build Settings
      shell: bash
      run: |
        echo "::group::[DEBUG] Docker Build Multi-Arch/Multi-Image"
        echo "[DEBUG] PLATFORMS env: '${GHA_CICD_DOCKER_PLATFORMS}'"
        echo "[DEBUG] IMAGE_URLS env: '${GHA_CICD_DOCKER_IMAGE_URLS}'"
        echo "[DEBUG] DOCKERFILE_PATH env: '${GHA_CICD_DOCKERFILE_PATH}'"
        echo "[DEBUG] DOCKER_CONTEXT env: '${GHA_CICD_DOCKER_CONTEXT}'"
        echo "::endgroup::"

    - name: Build images for each platform and image
      shell: bash
      run: |
        set -e
        echo "::group::Docker Build Execution"
        PLATFORMS="${GHA_CICD_DOCKER_PLATFORMS:-linux/amd64}"
        IMAGE_URLS="${GHA_CICD_DOCKER_IMAGE_URLS}"
        DOCKERFILE_PATH="${GHA_CICD_DOCKERFILE_PATH:-Dockerfile}"
        DOCKER_CONTEXT="${GHA_CICD_DOCKER_CONTEXT:-.}"

        echo "[DEBUG] Expanded PLATFORMS: $PLATFORMS"
        echo "[DEBUG] Expanded IMAGE_URLS: $IMAGE_URLS"
        echo "[DEBUG] Expanded DOCKERFILE_PATH: $DOCKERFILE_PATH"
        echo "[DEBUG] Expanded DOCKER_CONTEXT: $DOCKER_CONTEXT"

        for platform in $(echo "$PLATFORMS" | tr ',' ' '); do
          platform_key="${platform//\//_}"
          BUILD_ARGS_VAR="GHA_CICD_DOCKER_BUILD_ARGS_${platform_key}"
          BUILD_ARGS_FILE_VAR="GHA_CICD_DOCKER_BUILD_ARGS_FILE_${platform_key}"

          BUILD_ARGS="${!BUILD_ARGS_VAR}"
          BUILD_ARGS_FILE="${!BUILD_ARGS_FILE_VAR}"

          echo "[DEBUG] PLATFORM: $platform"
          echo "[DEBUG] PLATFORM_KEY: $platform_key"
          echo "[DEBUG] BUILD_ARGS_VAR: $BUILD_ARGS_VAR"
          echo "[DEBUG] BUILD_ARGS: $BUILD_ARGS"
          echo "[DEBUG] BUILD_ARGS_FILE_VAR: $BUILD_ARGS_FILE_VAR"
          echo "[DEBUG] BUILD_ARGS_FILE: $BUILD_ARGS_FILE"

          ARGS_FILE_OPTION=""
          if [ -n "$BUILD_ARGS_FILE" ] && [ -f "$BUILD_ARGS_FILE" ]; then
            ARGS_FILE_OPTION="--build-arg-file $BUILD_ARGS_FILE"
            echo "[DEBUG] Using build args file: $BUILD_ARGS_FILE"
          fi

          for image_url in $IMAGE_URLS; do
            IMAGE_TAG="${image_url}-${platform_key}"
            TAR_FILE="${IMAGE_TAG//[:\/]/_}.tar"

            echo "::group::Building $IMAGE_TAG for $platform"
            echo "[DEBUG] IMAGE_URL: $image_url"
            echo "[DEBUG] IMAGE_TAG: $IMAGE_TAG"
            echo "[DEBUG] TAR_FILE: $TAR_FILE"
            echo "[DEBUG] docker buildx build --platform \"$platform\" --file \"$DOCKERFILE_PATH\" --context \"$DOCKER_CONTEXT\" $( [ -n \"$BUILD_ARGS\" ] && echo \"--build-arg $BUILD_ARGS\" ) $ARGS_FILE_OPTION -t \"$IMAGE_TAG\" --output type=tar,dest=\"$TAR_FILE\" --push=false --load"

            docker buildx build \
              --platform "$platform" \
              --file "$DOCKERFILE_PATH" \
              --context "$DOCKER_CONTEXT" \
              $( [ -n "$BUILD_ARGS" ] && echo "--build-arg $BUILD_ARGS" ) \
              $ARGS_FILE_OPTION \
              -t "$IMAGE_TAG" \
              --output type=tar,dest="$TAR_FILE" \
              --push=false \
              --load

            echo "Built $IMAGE_TAG, saved as $TAR_FILE"
            echo "::endgroup::"
          done
        done
        echo "::endgroup::"