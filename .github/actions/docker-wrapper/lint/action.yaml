name: "Lint (Docker)"
description: "Lint a single Dockerfile using Hadolint. All config via GHA_CICD_ env vars. Groups output and uses GitHub logging functions for better visibility."

runs:
  using: "composite"
  steps:
    - name: Hadolint Linting
      shell: bash
      run: |
        echo "::group::Hadolint Linting Start"

        DOCKERFILE="${GHA_CICD_DOCKERFILE_PATH:-Dockerfile}"
        HADOLINT_IMAGE="${GHA_CICD_HADOLINT_IMAGE:-hadolint/hadolint:latest}"
        HADOLINT_CONFIG="${GHA_CICD_HADOLINT_CONFIG:-}"

        echo "Linting Dockerfile: $DOCKERFILE"
        if [ -n "$HADOLINT_CONFIG" ]; then
          echo "Hadolint config: $HADOLINT_CONFIG"
        else
          echo "No Hadolint config file provided. Using default rules."
        fi

        echo "::group::Hadolint Version"
        docker run --rm $HADOLINT_IMAGE hadolint --version | tee hadolint-report.txt
        echo "::endgroup::"

        echo "::group::Linting Output"
        if [ -n "$HADOLINT_CONFIG" ] && [ -f "$HADOLINT_CONFIG" ]; then
          docker run --rm -v "$GITHUB_WORKSPACE:/mnt" $HADOLINT_IMAGE hadolint --config "/mnt/$HADOLINT_CONFIG" "/mnt/$DOCKERFILE" | tee -a hadolint-report.txt
        else
          docker run --rm -v "$GITHUB_WORKSPACE:/mnt" $HADOLINT_IMAGE hadolint "/mnt/$DOCKERFILE" | tee -a hadolint-report.txt
        fi
        echo "::endgroup::"

        echo "::endgroup::Hadolint Linting End"

    - name: Upload Hadolint Report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: hadolint-report
        path: hadolint-report.txt