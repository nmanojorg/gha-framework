name: "Docker Image Test (dgoss)"
description: "Runs dgoss tests on a locally built Docker image using a single test file variable. No multi-arch/QEMU logic."

runs:
  using: "composite"
  steps:
    - name: Install dgoss/goss
      shell: bash
      run: |
        mkdir -p "$HOME/bin"
        curl -fsSL https://github.com/aelsabbahy/goss/releases/latest/download/goss-linux-amd64 -o "$HOME/bin/goss"
        curl -fsSL https://github.com/aelsabbahy/goss/releases/latest/download/dgoss -o "$HOME/bin/dgoss"
        chmod +x "$HOME/bin/goss" "$HOME/bin/dgoss"
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Run dgoss Tests
      shell: bash
      run: |
        if [ ! -f "$GHA_CICD_DGOSS_TEST_FILE" ]; then
          echo "::error::? dgoss test file not found: $GHA_CICD_DGOSS_TEST_FILE"
          exit 1
        fi
        export GOSS_FILE="$GHA_CICD_DGOSS_TEST_FILE"
        echo $PATH
        goss --version
        dgoss run --entrypoint tail ${{ env.GHA_CICD_LOCAL_IMAGE_NAME }} -f /dev/null | tee dgoss-report.txt

    - name: Upload dgoss Test Report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: dgoss-report
        path: dgoss-report.txt